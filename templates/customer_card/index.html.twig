{{ include('partials/header-reproupement.html.twig') }}

    <head>

       {#  {{ include('partials/head-css.html.twig') }} #}

        <!-- plugin css -->
{#         <link href="/libs/select2/css/select2.min.css" rel="stylesheet" type="text/css" />
        <link href="/libs/spectrum-colorpicker2/spectrum.min.css" rel="stylesheet" type="text/css">
        <link href="/libs/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">
        <link href="/libs/bootstrap-touchspin/jquery.bootstrap-touchspin.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="/libs/@chenfengyuan/datepicker/datepicker.min.css"> #}

        <!-- datepicker css -->
        {# <link rel="stylesheet" href="/libs/flatpickr/flatpickr.min.css"> #}

       

    </head>

    {{ include('partials/page-title.html.twig', {pagetitle: 'All', title: 'Clients Cards'|trans}) }}

        <div class="row">

            <form method="GET">

                {#                         
                    {{ (ability.id in company_abilities) ? 'selected' : '' }}
                    app.request.query 
                #}

                {#                          <input type="checkbox" id="customerPresence" name="customerPresence" {{ (app.request.query.get('customerPresence') != null) ? 'checked' : '' }}>
                <label for="customerPresence">Présents dans cette pèriode</label><br> #}



                <div class="row mb-3 pb-3 border border-dark rounded" style="background-color: #cfe2ff;">
                    <div class="col-md-2">
                        <div class="form-floating mt-3">
                            <select name="customerPresence" class="form-select" id="customerPresence" aria-label="Floating label select example">
                                <option value="1" {{ (app.request.query.get('customerPresence') == 1 ) ? 'selected' : '' }}>{% trans %}Presence{% endtrans %}</option>
                                <option value="2" {{ (app.request.query.get('customerPresence') == 2 ) ? 'selected' : '' }}>{% trans %}Operations{% endtrans %}</option>
                            </select>
                            <label for="customerPresence">{% trans %}Research on{% endtrans %} </label>
                        </div>
                    </div>                            
                    {% set now = "now"|date("Y-m-d") %}
                    <div class="col-md-3">
                        {# <div><label for="dateStart" class=" col-form-label">Date Start</label></div> #}
                        <input class="form-control mt-3" name="dateStart" placeholder="Start Date" type="date" value="{{ (app.request.query.get('dateStart') != '') ? app.request.query.get('dateStart') : now }}" id="dateStart">
                        <input class="form-control" name="dateEnd" placeholder="End Date" type="date" value="{{ (app.request.query.get('dateEnd') != '') ? app.request.query.get('dateEnd') : now }}" id="dateEnd">                               
                    </div>
                </div>
                <div class="row">
                    <div id="divNatureTransfer" class="col-md-2 {{ (app.request.query.get('customerPresence') == 2 ) ? '' : 'd-none' }}">
                        <div class="form-floating mb-3">
                            <select name="natureTransfer" class="form-select" id="natureTransfer" aria-label="Floating label select example">
                                <option value="all" selected>{% trans %}All Natures Transfers{% endtrans %}</option>
                                <option value="1" {{ (app.request.query.get('natureTransfer') == 1 ) ? 'selected' : '' }}>{% trans %}Arrival{% endtrans %}</option>
                                <option value="2" {{ (app.request.query.get('natureTransfer') == 2 ) ? 'selected' : '' }}>{% trans %}Inter Hotel{% endtrans %}</option>
                                <option value="3" {{ (app.request.query.get('natureTransfer') == 3 ) ? 'selected' : '' }}>{% trans %}Departure{% endtrans %}</option>
                            </select>
                            <label for="natureTransfer">{% trans %}Select Nature Transfer{% endtrans %}</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2 {{ ((app.user.roles|length == 2) and ('ROLE_REP' in app.user.roles)) ? 'd-none' : '' }}  ">
                        <div class="form-floating mb-3">
                            <select name="reps" class="form-select" id="reps" aria-label="Floating label select example">
                                <!--Si le user est uniquement un rep (role_rep & role_user) -->
                                {% if ((app.user.roles|length == 2) and ('ROLE_REP' in app.user.roles)) %}
                                    <option value="{{ app.user.id }}" selected >{{ app.user }}  </option>
                                {% else %}
                                    <!--Sinon-->
                                    <option value="all" selected>{% trans %}All Reps{% endtrans %}</option>
                                    {% for rep in reps|sort((a, b) => a.username <=> b.username) %} 
                                        <option value="{{ rep.id }}" {{ (app.request.query.get('reps') == rep.id ) ? 'selected' : '' }} >{{ rep }}  </option>
                                    {% endfor %}
                                {% endif %}

                            </select>
                            <label for="reps">{% trans %}Select a Rep{% endtrans %}</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating mb-3">
                            <select name="status" class="form-select" id="statusForm" aria-label="Floating label select example">
                                <option value="all" selected>{% trans %}All Status{% endtrans %}</option>
                                {% for status in statusList%}
                                    <option value="{{ status.id }}" {{ (app.request.query.get('status') == status.id ) ? 'selected' : '' }}>{{ status.name }}</option>
                                {% endfor %}

                            </select>
                            <label for="statusForm">{% trans %}Select Status{% endtrans %}</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating mb-3">
                            <select name="agency" class="form-select" id="agency" aria-label="Floating label select example">
                                    <option value="all" selected>{% trans %}All Agencies{% endtrans %}</option>
                                    {% for agency in agencies%}
                                        <option value="{{ agency.id }}" {{ (app.request.query.get('agency') == agency.id ) ? 'selected' : '' }}>{{ agency.name|title }}</option>
                                    {% endfor %}
                            </select>
                            <label for="agency">{% trans %}Select Agency{% endtrans %}</label>
                        </div>
                    </div>      
                    <div class="col-md-2">
                        <div class="form-floating mb-3">
                            <select name="hotel" class="form-select-perso" id="hotel" aria-label="Floating label select example">
                                    <option value="all" selected>{% trans %}All Hotels{% endtrans %}</option>
                                    {% for hotel in hotels%}
                                        <option value="{{ hotel.id }}" {{ (app.request.query.get('hotel') == hotel.id ) ? 'selected' : '' }}>{{ hotel.name|title }}</option>
                                    {% endfor %}
                            </select>
                            {# <label for="hotel">Select Hotel</label> #}
                        </div>
                    </div>    
                    <div id="divFlightNumber" class="col-md-2 {{ (app.request.query.get('customerPresence') == 2 ) ? '' : 'd-none' }} {{ (app.request.query.get('natureTransfer') == 2 ) ? 'd-none' : ''  }}">
                        <div class="form-floating mb-3">
                            <input name="flightNumber" type="text" class="form-control" id="flightNumber" placeholder="Enter Name" value="{{ (app.request.query.get('flightNumber')) }}">
                            <label for="flightNumber">Flight Number</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-floating mb-3">
                            <input name="search" type="text" class="form-control-perso" id="search" placeholder="{% trans %}Name{% endtrans %}, #RSA, #Voucher" value="{{ (app.request.query.get('search')) }}">
                            {# <label for="search">Name, # RSA, # Voucher, # Jumbo </label> #}
                        </div>
                    </div>

                </div>
                    <div class="text-center text-md-start col-md-2 ">
                        <input type="submit" class="btn btn-primary px-5 py-3" value="{% trans %}Submit{% endtrans %}">
                    </div>

            </form>

            <div class="row ms-5 mt-5">
                {% if count > 1 %}
                    {% trans %}There are{% endtrans %} {{ count }} {% trans %}matching results{% endtrans %}.
                {% else  %}
                    {% trans %}There is{% endtrans %} {{ count }} {% trans %}matching result{% endtrans %}.
                {% endif %}
            </div>


        </div>

        <div class="row mt-5 mb-5 mb-lg-2">

            {# si le nature transfert == 1 alors custommer card = customer cards ou le tranfer > 0 #}

            <div class="d-flex justify-content-center mb-5">
            {# {% do customer_cards.setPageRange(1) %} #}
                {{ knp_pagination_render(customer_cards, 'modules/pagination.html.twig') }}
            </div>

            {% for customer_card in customer_cards|sort((a, b) => a.holder <=> b.holder)%}

            <div class="col-xl-4 col-sm-6">
                {% if customer_card.transferArrivals|length > 1 %}<div class="card border border-danger">{% else %}<div class="card"> {% endif %}
                    {# TODO: !!! A ATTENTION A transferArrivals[0] -> si y a mieux ... #}
                    {% if customer_card.transferArrivals[0].staff is not null %}
                        {% if customer_card.transferArrivals|length > 1 %}
                        <div class="text-end m-3">
                            {% for transferArrival in customer_card.transferArrivals %}
                            <span class="badge rounded-pill bg-danger p-2">{{ transferArrival.staff }}</span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="ribbon ribbon-top-right">
                            <span>{{ customer_card.transferArrivals[0].staff }}</span>
                        </div>
                        {% endif %}
                    {% endif %}
                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <div class="d-none d-md-block flex-shrink-0 me-4">
                                <div class="avatar-sm">
                                    <span class="avatar-title bg-soft-primary text-primary font-size-16 rounded-circle">
                                        <i class="fas fa-id-card text-dark"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="flex-grow-1 align-self-center">
                                <div class="border-bottom pb-1">
                                    <p class="text-muted">
                                        <i class="me-1">#</i> {{ customer_card.reservationNumber }}
                                    </p>
                                    <h5 class="text-truncate font-size-16 mb-1"><a href="{{ path('app_customer_card_show', {id:customer_card.id}|merge(app.request.query.all) ) }}" class="text-dark text-wrap">{{ customer_card.holder|title }}</a></h5>
                                    <p>
                                    {% for transferArrival in customer_card.transferArrivals %}
                                        {% if transferArrival.status == "No Show" %}
                                            <span class="badge rounded-pill bg-danger">{{ transferArrival.status }}</span>
                                        {% else %}
                                            <span class="badge rounded-pill bg-success">{{ transferArrival.status }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    </p>
                                    <p class="text-muted">
                                        {{ customer_card.agency|title }}
                                    </p>
                                </div>


                                <div class="border-bottom mt-3 pt-1 pb-1">
                                    <p class="text-muted">
                                        {% for hotel in customer_card.transferArrivals %} 
                                            <i class="fas fa-hotel"></i> {% trans %}Arrival{% endtrans %}: {{ hotel.fromStart|title }} - {{ hotel.toArrival|title }}<br>
                                        {% endfor %}
                
                                        {% for hotel in customer_card.transferInterHotels %} 
                                           <i class="fas fa-hotel"></i> {% trans %}Inter Hotel{% endtrans %}: {{ hotel.toArrival|title }}<br>
                                        {% endfor %} 
                                                                        
                                        {% for hotel in customer_card.transferDeparture %} 
                                            <i class="fas fa-hotel"></i> {% trans %}Departure{% endtrans %}: {{ hotel.toArrival|title }}<br>
                                        {% endfor %} 
                                    </p>
                                </div>

                                {% for transferArrival in customer_card.transferArrivals %} 
                                <div class="row">
                                    <div class="col-4">
                                        <div class="mt-3">
                                            <p class="text-muted mb-2">{% trans %}Adults{% endtrans %}</p>
                                            <h5 class="font-size-16 mb-0">{{ transferArrival.transferVehicleArrival ? transferArrival.transferVehicleArrival.adultsNumber : transferArrival.adultsNumber }}</h5>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="mt-3">
                                            <p class="text-muted mb-2">{% trans %}Children{% endtrans %}</p>
                                            <h5 class="font-size-16 mb-0">{{ transferArrival.transferVehicleArrival ? transferArrival.transferVehicleArrival.childrenNumber : transferArrival.childrenNumber }}</h5>
                                        </div>
                                    </div>                                                    
                                    <div class="col-4">
                                        <div class="mt-3">BB</p>
                                            <h5 class="font-size-16 mb-0">{{ transferArrival.transferVehicleArrival ? transferArrival.transferVehicleArrival.babiesNumber : transferArrival.babiesNumber }}</h5>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}


                                {# START SHOW MORE #}
                                <div class="accordion accordion-flush" id="accordionFlush{{ customer_card.id }}">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne{{ customer_card.id }}" aria-expanded="false" aria-controls="flush-collapseOne{{ customer_card.id }}">
                                            <span class="badge bg-primary"> {% trans %}Show more{% endtrans %}</span>
                                        </button>
                                        </h2>
                                        <div id="flush-collapseOne{{ customer_card.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionFlush{{ customer_card.id }}">
                                            <div class="accordion-body">
                                                {% for transfer in customer_card.transferArrivals %}
                                                    <div class="row mt-3 p-3 shadow-lg border border-1 border-primary rounded">
                                                        <h6><i class="mdi mdi-airplane-landing"></i> {% trans %}Arrival{% endtrans %}</h6>
                                                        <div class="col-4">
                                                            <div class="mt-3">
                                                                <p class="text-muted mb-2">{% trans %}Date{% endtrans %}</p>
                                                                <h5 class="font-size-16 mb-0">{{ transfer.transferVehicleArrival ? transfer.transferVehicleArrival.date | date('d-m-Y') : transfer.date | date('d-m-Y') }}</h5>
                                                            </div>
                                                        </div>
                                                    <div class="col-4">
                                                            <div class="mt-3">
                                                                <p class="text-muted mb-2">{% trans %}Hour{% endtrans %}</p>
                                                                <h5 class="font-size-16 mb-0">{{ transfer.transferVehicleArrival ? transfer.transferVehicleArrival.date | date('H:i') : transfer.hour | date('H:i')}}</h5>
                                                            </div>
                                                        </div>            
                                                        <div class="col-4">
                                                            <div class="mt-3">
                                                                <p class="text-muted mb-2">{% trans %}Flight{% endtrans %} #</p>
                                                                <h5 class="font-size-16 mb-0">{{ transfer.transferVehicleArrival ? transfer.transferVehicleArrival.flightNumber|upper : transfer.flightNumber|upper }}</h5>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                                {% for transfer in customer_card.transferInterHotels %}
                                                    <div class="row mt-3 p-3 shadow-lg border border-1 border-primary rounded">
                                                        <h6><i class="mdi mdi-airplane-landing"></i> {% trans %}Inter Hotel{% endtrans %}</h6>
                                                        <div class="col-4">
                                                            <div class="mt-3">
                                                                <p class="text-muted mb-2">{% trans %}Date{% endtrans %}</p>
                                                                <h5 class="font-size-16 mb-0">{{ transfer.date | date('d-m-Y') }}</h5>
                                                            </div>
                                                        </div>
                                                    <div class="col-4">
                                                            <div class="mt-3">
                                                                <p class="text-muted mb-2">{% trans %}Hour{% endtrans %}</p>
                                                                <h5 class="font-size-16 mb-0">{{ transfer.pickup | date('H:i')}}</h5>
                                                            </div>
                                                        </div>            
                                                    </div>
                                                {% endfor %}


                                                {% for transfer in customer_card.transferDeparture %}
                                                    <div class="row mt-3 p-3 shadow-lg border border-1 border-primary rounded">
                                                        <h6><i class="mdi mdi-airplane-landing"></i> {% trans %}Departure{% endtrans %}</h6>
                                                        <div class="col-4">
                                                            <div class="mt-3">
                                                                <p class="text-muted mb-2">{% trans %}Date{% endtrans %}</p>
                                                                <h5 class="font-size-16 mb-0">{{ transfer.date | date('d-m-Y') }}</h5>
                                                            </div>
                                                        </div>
                                                    <div class="col-4">
                                                            <div class="mt-3">
                                                                <p class="text-muted mb-2">{% trans %}Hour{% endtrans %}</p>
                                                                <h5 class="font-size-16 mb-0">{{ transfer.hour | date('H:i')}}</h5>
                                                            </div>
                                                        </div>            
                                                        <div class="col-4">
                                                            <div class="mt-3">
                                                                <p class="text-muted mb-2">{% trans %}Flight{% endtrans %} #</p>
                                                                <h5 class="font-size-16 mb-0">{{ transfer.flightNumber|upper }}</h5>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {# END SHOW MORE #}

                            </div>
                        </div>

                    </div>
                </div>
            </div>

            {% endfor %}

            <div class="d-flex justify-content-center">
            {# {% do customer_cards.setPageRange(1) %} #}
            {{ knp_pagination_render(customer_cards, 'modules/pagination.html.twig') }}
            </div>


        </div>


<!-- footer -->

                    </div> <!-- container-fluid -->
                </div>
                <!-- End Page-content -->

                {{ include('partials/footer.html.twig') }}
            </div>
            <!-- end main content-->

            <!-- Le menu créé pour les rep en bas de page -->
            {% if "ROLE_REP" in app.user.roles %}
                {{ include('partials/rep-bottom-menu.html.twig') }}            
            {% endif %}
        </div>
        <!-- END layout-wrapper -->
        {{ include('partials/right-sidebar.html.twig') }}

        {{ include('partials/vendor-scripts.html.twig') }}

        {# <script src="{{ asset('/libs/apexcharts/apexcharts.min.js')}}"></script> #}
        {#  <script src="/js/pages/dashboard.init.js"></script> #}
       

        <!-- App js --> 
        <script src="/js/jsPersos/gestionFiltreCustomerCards.js"></script>
        <script src="/js/app.js"></script>

    </body>

</html>